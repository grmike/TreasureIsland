<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" >
<head>
    <title>Остров сокровищ</title>
    <style type="text/css">
    
        #map {width: 100%;}
        #map table {margin: auto;}
        #map table td {width: 50px; height: 50px; border: 1px black solid; }
    </style>
    <script src="jquery-2.0.2.min.js" type="text/javascript"></script>
    <script src="mapfields-1.0.0.js" type="text/javascript"></script>
    <script src="mobjects-1.0.0.js" type="text/javascript"></script>
    <script type="text/javascript">

        var Map = function () {
        }

        $.extend(Map.prototype, {

            init: function () {

                var fields = {};
                var i, j;
                for (i = 1; i < 12; i++) {
                    fields[i] = {};
                    for (j = 1; j < 12; j++) {
                        fields[i][j] = new GrassField(i, j, this);
                    }
                }

                fields[5][5] = new RockField(5, 5, this);
                fields[7][3] = new RockField(7, 3, this);
                fields[4][8] = new RockField(4, 8, this);
                fields[9][2] = new RockField(9, 2, this);
                fields[5][9] = new RockField(5, 9, this);
                fields[6][7] = new RockField(6, 7, this);

                fields[0] = {};
                fields[12] = {};

                for (i = 0; i < 13; i++) {
                    fields[0][i] = new SeaField(0, i, this);
                    fields[12][i] = new SeaField(12, i, this);
                    fields[i][0] = new SeaField(i, 0, this);
                    fields[i][12] = new SeaField(i, 12, this);
                }

                fields[1][1] = new SeaField(1, 1, this);
                fields[1][11] = new SeaField(1, 11, this);
                fields[11][1] = new SeaField(11, 1, this);
                fields[11][11] = new SeaField(11, 11, this);

                this.fields = fields;
            },
            getField: function (field, direction) {
                switch (direction) {
                    case "up":
                        if (field.y <= 0) return;
                        return this.fields[field.x][field.y - 1];
                        break;
                    case "down":
                        if (field.y >= 12) return;
                        return this.fields[field.x][field.y + 1];
                        break;
                    case "left":
                        if (field.x <= 0) return;
                        return this.fields[field.x - 1][field.y];
                        break;
                    case "right":
                        if (field.x >= 12) return;
                        return this.fields[field.x + 1][field.y];
                        break;
                    case "left-up":
                        if (field.x <= 0) return;
                        if (field.y <= 0) return;
                        return this.fields[field.x - 1][field.y - 1];
                        break;
                    case "left-down":
                        if (field.x <= 0) return;
                        if (field.y >= 12) return;
                        return this.fields[field.x - 1][field.y + 1];
                        break;
                    case "right-up":
                        if (field.x >= 12) return;
                        if (field.y <= 0) return;
                        return this.fields[field.x + 1][field.y - 1];
                        break;
                    case "right-down":
                        if (field.x >= 12) return;
                        if (field.y >= 12) return;
                        return this.fields[field.x + 1][field.y + 1];
                        break;
                }
            },
            draw: function (mapId) {

                var mapElm = $('#' + mapId);
                if (typeof (mapElm) == 'undefined') return;

                var table = $('<table style="border: 1px black solid;"></table>');
                mapElm.append(table);
                for (var j = 0; j < 13; j++) {
                    var tr = $('<tr></tr>');
                    table.append(tr);
                    for (var i = 0; i < 13; i++) {
                        var td = $('<td></td>');
                        var img = $('<img />');
                        td.append(img);
                        this.fields[i][j].setView(td);
                        this.fields[i][j].view.drawField();
                        tr.append(td);
                    }
                }
            },
            addTips: function () {
                for (var i = 0; i < 13; i++) {
                    for (var j = 0; j < 13; j++) {
                        var field = this.fields[i][j];
                        field.view.elm.click(field, function (event) {

                            //alert(event.data.color);
                            var field = event.data;
                            if (field.object != null) {
                                // если щелкнули по объекту - то выделяем его
                                if (currentObject != null) {
                                    currentObject.unselect();
                                    currentObject.field.behavior.unshowMovingFields();
                                }
                                currentObject = field.object;
                                currentObject.select();
                            }
                            else if (currentObject != null) {
                                // если щелкнули по пустому полю - перемещаем туда объект
                                if (currentObject.canMove(field)) {
                                    currentObject.field.moveObjectToField(field);
                                }
                                else alert('Нельзя переместить сюда объект');
                            }
                        });
                    }
                }
            }
        });



        var FieldBehavior = function (map, x, y) {
            this.map = map;
            this.x = x;
            this.y = y;
        }

        $.extend(FieldBehavior.prototype, {
            getPathFields: function () {
                if (typeof (this.pathfields) == "undefined") {
                    var self = this;
                    self.pathfields = {};
                    var t = this.getMovingFields();
                    t.forEach(function (element, index) {
                        var each = self.map.getField(self, element);
                        if (typeof (each) != "undefined") self.pathfields[each.name] = each;
                    });
                }
                return this.pathfields;
            },
            showMovingFields: function (area) {
                var flds = this.getPathFields();
                for (var each in flds) {
                    if (flds[each].area == area) flds[each].view.selectForMove();
                }
            },
            unshowMovingFields: function () {
                var flds = this.getPathFields();
                for (var each in flds) {
                    flds[each].view.unselectForMove();
                }
            },
            getMovingFields: function () {
                return ["up", "down", "left", "right", "left-up", "left-down", "right-up", "right-down"];
            }
        });



        var ViewField = function (elm, pic, color) {
            this.elm = elm;
            this.pic = pic;
            this.color = color;
        }

        $.extend(ViewField.prototype, {

            drawField: function () {
                if (typeof (this.pic) == 'undefined') this.elm.css("backgroundColor", this.color);
                else this.elm.css("backgroundImage", "url(" + this.pic + ")").css("opacity", "1");
            },
            selectObject: function () {
                this.elm.css("backgroundImage", "").css("backgroundColor", "red").css("opacity", "0.8");
            },
            unselectObject: function () {
                this.drawField();
            },
            selectForMove: function () {
                this.elm.css("opacity", "0.8");
            },
            unselectForMove: function () {
                this.elm.css("opacity", "1");
            },
            drawObject: function (objectPicture) {
                $(":first-child", this.elm).attr("src", objectPicture);
            },
            undrawObject: function () {
                $(":first-child", this.elm).attr("src", "pics/empty.gif");
            }
        });

        var currentObject = null;

        $(document).ready(function () {

            $(document).keypress(function (event) {
                if (event.keyCode == 38) {
                    if (currentObject != null) currentObject.move("up");
                }
                else if (event.keyCode == 40) {
                    if (currentObject != null) currentObject.move("down");
                }
                else if (event.keyCode == 37) {
                    if (currentObject != null) currentObject.move("left");
                }
                else if (event.keyCode == 39) {
                    if (currentObject != null) currentObject.move("right");
                }

            });

            var map = new Map();
            map.init();
            map.draw('map');
            map.addTips();

            var ship, obj, i;
            for (i = 0; i < 6; ++i) {

                ship = new Ship();
                map.fields[i * 2][0].addObject(ship);
                ship.draw();
            }

            currentObject = ship;
            currentObject.select();

            for (i = 0; i < 6; ++i) {

                obj = new Warrior();
                map.fields[i * 2 + 1][3].addObject(obj);
                obj.draw();
            }
            obj = new Chucha();
            map.fields[5][3].addObject(obj);
            obj.draw();

            obj = new Chucha();
            map.fields[7][10].addObject(obj);
            obj.draw();

            obj = new Deer();
            map.fields[3][8].addObject(obj);
            obj.draw();

            obj = new Deer();
            map.fields[9][3].addObject(obj);
            obj.draw();
        });
        
    </script>
</head>
<body>
<h1>Остров сокровищ</h1>
<img />
<div id="map"></div>
<div style="width: 50px; height: 50px; background-color: black;">
<img src="pics/rocks.gif" style="float: left; position: relative; opacity: 0.8;"/>
</div>
<br/>
<br/>
<br/>
<br/>
<img src="pics/sea.gif" style="float: left; position: relative; left: -50px; opacity: 0.5;"/>
</body>
</html>
